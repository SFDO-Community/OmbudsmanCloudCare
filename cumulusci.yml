minimum_cumulusci_version: "3.11.0"
project:
  name: OmbudsmanCloudCare
  package:
    name: OmbudsmanCloudCare
    api_version: "48.0"
  dependencies:
    - github: "https://github.com/SalesforceFoundation/NPSP"
    - namespace: Mopsy
      version: "1.54"
  source_format: sfdx

orgs:
  scratch:
    demo:
      config_file: orgs/demo.json
      days: 30

tasks:
  deploy_dev_config:
    description: Deploys the post install configuration for an unmanaged DE org
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/config/dev

  dx_install_mopsy:
    class_path: cumulusci.tasks.sfdx.SFDXOrgTask
    options:
      command: "force:package:install -p 04t1n000002KQ4hAAG"

  dx_status:
    class_path: cumulusci.tasks.sfdx.SFDXOrgTask
    options:
      command: "force:source:status"

  ensure_record_type:
    name: Ensure Contact Record Types
    description: This will ensure Record Types are enabled for the Contact object in your org before installing OCC. If there are no Contact record types yet, it will create one called Family Member.
    class_path: cumulusci.tasks.salesforce.EnsureRecordTypes
    options:
      record_type_label: Family Member
      record_type_developer_name: Family_Member
      sobject: Contact

    uninstall_packaged_incremental:
      description: Deletes any metadata from the package in the target org not in the local workspace
      class_path: cumulusci.tasks.salesforce.UninstallPackagedIncremental
      options:
        ignore:
          QuickAction:
            - NewEvent
            - NewCase
            - SendEmail
            - Case.SendEmail
          FlexiPage:
            - NPSP_Address_Record_Page
            - NPSP_Deliverable
            - NPSP_Engagement_Plan_Record_Page
            - NPSP_GAU_Allocation
            - NPSP_General_Accounting_Unit
          List_view:
            - Household_Accounts
            - Resource_Organization_Accounts
          Compact_layouts:
            - OCC_HH_Acct_Compact_Layout
            - OCC_Org_Acct_Compact_Layout

  robot:
    options:
      suites: robot/OmbudsmanCloudCare/tests
      options:
        outputdir: robot/OmbudsmanCloudCare/results

  robot_testdoc:
    options:
      path: robot/OmbudsmanCloudCare/tests
      output: robot/OmbudsmanCloudCare/doc/OmbudsmanCloudCare_tests.html

flows:
  config_qa:
    steps:
      3:
        task: load_dataset
  config_dev:
    steps:
      3:
        task: deploy_dev_config
      4:
        task: load_dataset

  dependencies:
    steps:
      3:
        task: ensure_record_type

plans:
  existing_org:
    slug: install
    title: Install Ombudsman Cloud Care
    is_listed: True
    tier: primary
    preflight_message: "This will install Ombudsman Cloud Care into your org."
    post_install_message: "Thanks for installing Ombudsman Cloud Care. Please visit the [Ombudsman Cloud Care](https://powerofus.force.com/s/group/0F91E0000000hq1SAA) community group on the Power of Us Hub for any questions about Ombudsmand Cloud Care."
    error_message: "To get help with this error, go to [Ombudsman Cloud Care](https://powerofus.force.com/s/group/0F91E0000000hq1SAA) community group on the Power of Us Hub and post a question include any details about the install."

    steps:
      1:
        task: update_dependencies
      2:
        task: deploy
        options:
          path: unpackaged/pre
        ui_options:
          name: OCC Pre Install Config for Salesforce
      3:
        task: ensure_record_type
        ui_options:
          name: Contact Record Types
      4:
        task: install_managed
      5:
        task: deploy_post
        options:
          unmanaged: False
        ui_options:
          first:
            name: OCC Post Intall Config for Salesforce
