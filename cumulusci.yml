minimum_cumulusci_version: "3.11.0"
project:
  name: OmbudsmanCloudCare
  package:
    name: OmbudsmanCloudCare
    api_version: "48.0"
  dependencies:
    - github: "https://github.com/SalesforceFoundation/NPSP"
  source_format: sfdx

orgs:
  scratch:
    demo:
      config_file: orgs/demo.json
      days: 30

tasks:
  add_standard_value_set_entries_caseorigin:
    description: Adds specified picklist entries to Case Origin Standard Value Set.
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names:
        - CaseOrigin
      entries:
        - label: Social Media
          fullName: Social Media

  add_standard_value_set_entries_casepriority:
    description: Adds specified picklist entries to Case Priority Standard Value Set.
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names:
        - CasePriority
      entries:
        - label: Mandatory Reportable
          fullName: Mandatory Reportable

  add_standard_value_set_entries_casereason:
    description: Adds specified picklist entries to Case Reason Standard Value Set.
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names:
        - CaseReason
      entries:
        - label: Childcare
          fullName: Childcare
        - label: Deployment/FRG
          fullName: Deployment/FRG
        - label: Education
          fullName: Education
        - label: Emergency/Crisis
          fullName: Emergency/Crisis
        - label: Employment
          fullName: Employment
        - label: EFMP
          fullName: EFMP
        - label: Financial/Pay
          fullName: Financial/Pay
        - label: Individual Augmentee
          fullName: Individual Augmentee
        - label: Legal
          fullName: Legal
        - label: Medical
          fullName: Medical
        - label: Military Records
          fullName: Military Records
        - label: MWR
          fullName: MWR
        - label: Newsetter
          fullName: Newsetter
        - label: Red Cross Message
          fullName: Red Cross Message
        - label: Relocation/Housing/Sponsor
          fullName: Relocation/Housing/Sponsor
        - label: Sexual Assault Prevention
          fullName: Sexual Assault Prevention
        - label: Social Media
          fullName: Social Media
        - label: Other Info and Referral
          fullName: Other Info and Referral

  add_standard_value_set_entries_salutation:
    description: Adds specified picklist entries to Salutation Standard Value Set.
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names:
        - Salutation
      entries:
        - label: Mx.
          fullName: Mx.

  deploy_dev_config:
    description: Deploys the post install configuration for an unmanaged DE org
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/config/dev

  deploy_qa_config:
    description: Deploys the post install configuration for an unmanaged QA org
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/config/qa

  deploy_standardvaluesets:
    description: Deploys the pre install configuration for an unmanaged scratch org
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/config/standardValueSets

  dx_status:
    class_path: cumulusci.tasks.sfdx.SFDXOrgTask
    options:
      command: "force:source:status"

  ensure_record_type:
    name: Ensure Contact Record Types
    description: This will ensure Record Types are enabled for the Contact object in your org before installing OCC. If there are no Contact record types yet, it will create one called Family Member.
    class_path: cumulusci.tasks.salesforce.EnsureRecordTypes
    options:
      record_type_label: Family Member
      record_type_developer_name: Family_Member
      sobject: Contact

  list_changes:
    name: List Changes from Scratch Org
    description: List the changes from a scratch org
    class_path: cumulusci.tasks.salesforce.sourcetracking.ListChanges
    options:
      exclude: "Profile, PicklistValue, StandardValueSet"

  retrieve_changes:
    name: Retrieve Changes from Scratch Org
    description: Retrieve changed components from a scratch org
    class_path: cumulusci.tasks.salesforce.sourcetracking.RetrieveChanges
    options:
      exclude: "Profile, PicklistValue, StandardValueSet"

  uninstall_packaged_incremental:
    description: Deletes any metadata from the package in the target org not in the local workspace
    class_path: cumulusci.tasks.salesforce.UninstallPackagedIncremental
    options:
      ignore:
        QuickAction:
          - NewTask
          - LogACall
          - NewEvent
          - NewCase
          - Case.LogACall
        FlexiPage:
          - NPSP_Address_Record_Page
          - NPSP_Deliverable
          - NPSP_Engagement_Plan_Record_Page
          - NPSP_GAU_Allocation
          - NPSP_General_Accounting_Unit
        List_view:
          - Household_Accounts
          - Resource_Organization_Accounts
        Compact_layouts:
          - OCC_HH_Acct_Compact_Layout
          - OCC_Org_Acct_Compact_Layout

  robot:
    options:
      suites: robot/OmbudsmanCloudCare/tests
      options:
        outputdir: robot/OmbudsmanCloudCare/results

  robot_testdoc:
    options:
      path: robot/OmbudsmanCloudCare/tests
      output: robot/OmbudsmanCloudCare/doc/OmbudsmanCloudCare_tests.html

flows:
  config_qa:
    steps:
      3:
        task: deploy_qa_config
      4:
        task: load_dataset
  config_dev:
    steps:
      3:
        task: deploy_dev_config
      4:
        task: load_dataset

  dependencies:
    steps:
      3:
        task: deploy_standardvaluesets
      4:
        task: ensure_record_type

plans:
  existing_org:
    slug: install
    title: Install Ombudsman Cloud Care
    is_listed: True
    tier: primary
    preflight_message: "This will install Ombudsman Cloud Care into your org."
    post_install_message: "Thanks for installing Ombudsman Cloud Care. Please visit the [Ombudsman Cloud Care](https://powerofus.force.com/s/group/0F91E0000000hq1SAA) community group on the Power of Us Hub for any questions about Ombudsman Cloud Care."
    error_message: "To get help with this error, go to [Ombudsman Cloud Care](https://powerofus.force.com/s/group/0F91E0000000hq1SAA) community group on the Power of Us Hub and post a question include any details about the install."

    steps:
      1:
        task: update_dependencies
      2:
        task: deploy_pre
        options:
          path: unpackaged/pre
        ui_options:
          name: OCC Pre Install Config for Salesforce
      3:
        task: add_standard_value_set_entries_caseorigin
        ui_options:
          name: Adds specified picklist entries to Case Origin Standard Value Set
      4:
        task: add_standard_value_set_entries_casereason
        ui_options:
          name: Adds specified picklist entries to Case Reason Standard Value Set
      5:
        task: add_standard_value_set_entries_casepriority
        ui_options:
          name: Adds specified picklist entries to Case Priority Standard Value Set
      6:
        task: add_standard_value_set_entries_salutation
        ui_options:
          name: Adds specified picklist entries to Salutation Standard Value Set
      7:
        task: ensure_record_type
        ui_options:
          name: Contact Record Types
      8:
        task: install_managed
      9:
        task: deploy_post
        options:
          unmanaged: False
        ui_options:
          first:
            name: OCC Post Install Config for Salesforce
